name: Deploy to Vercel and set VITE_API_BASE

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy and update env
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install
        run: npm ci

      - name: Deploy to Vercel
        id: vercel
        uses: amondawa/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: Set VITE_API_BASE on Vercel
        if: steps.vercel.outputs.url != ''
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          DEPLOY_URL: ${{ steps.vercel.outputs.url }}
        run: |
          echo "Deploy URL: $DEPLOY_URL"
          # Create or update environment variable VITE_API_BASE to point to the deployed app
          PAYLOAD=$(jq -n --arg key "VITE_API_BASE" --arg value "https://$DEPLOY_URL" '{key:$key, value:$value, target:["production"], type: "plain"}')
          echo "$PAYLOAD" > /tmp/payload.json

          # Try creating the env var. If it already exists, Vercel will still create a duplicate.
          curl -s -X POST "https://api.vercel.com/v1/projects/${VERCEL_PROJECT_ID}/env" \
            -H "Authorization: Bearer ${VERCEL_TOKEN}" \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json | jq .

      - name: Success
        run: echo "Deployment finished and VITE_API_BASE update attempted."
